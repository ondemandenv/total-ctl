# `InfrastructureStack`

The `InfrastructureStack` is the foundation of the application's environment. It provisions all the essential, shared resources that other stacks depend on.

## Conditional DocumentDB Deployment (Cost Optimization)

To optimize costs, this stack implements a **conditional deployment strategy** for the DocumentDB cluster.

-   **Production-like Environments**: For environments with names containing `prod`, `main`, or `customer-facing`, a full DocumentDB cluster is provisioned to ensure data persistence and enable true stateless testing.
-   **Development/Testing Environments**: For all other environments (e.g., `feature/*`, `bugfix/*`), the DocumentDB cluster deployment is **skipped entirely**.

When DocumentDB is not deployed, the backend application is designed to automatically fall back to its **in-memory data store**. This provides significant cost savings and faster deployment times for ephemeral development and testing environments.

## Key Resources

- **VPC (`ec2.Vpc`)**: A new VPC is created for each environment, providing network isolation. It's configured with:
  - Two availability zones for high availability.
  - One NAT Gateway for outbound internet access from private subnets.
  - Both `PRIVATE_WITH_EGRESS` and `PUBLIC` subnets.

- **S3 Buckets**:
  - **`cfPubBucket` (`s3.Bucket`)**: A public-read S3 bucket that hosts the static assets for the frontend application. It's configured as a website with `index.html` as the index and error document.
  - **`cfPrivateBucket` (`s3.Bucket`)**: A private S3 bucket for storing sensitive or user-generated content, accessible only via CloudFront with an Origin Access Identity (OAI).

- **DocumentDB Cluster (`docdb.DatabaseCluster`)**:
  - **Note**: This resource is only provisioned in production-like environments. In all other environments, it is skipped to save costs.
  - A DocumentDB cluster is provisioned within the VPC's private subnets.
  - The master username is retrieved from the environment variable `DATABASE_ADM_USER` (defaults to "dbadmin"), and the password is autogenerated and stored in AWS Secrets Manager.
  - **Critical**: The `removalPolicy` is set to `RETAIN` to prevent accidental data loss, and `deletionProtection` is enabled for production environments.
  - Backup retention is set to 7 days.

- **Route 53 Hosted Zone (`route53.IHostedZone`)**:
  - It looks up an existing hosted zone based on the `baseDomainName` prop. This hosted zone is used for creating DNS records.

- **ACM Certificate (`acm.Certificate`)**:
  - An SSL/TLS certificate is created in the `us-east-1` region (a requirement for CloudFront) to enable HTTPS for the environment's domain.

- **ECS Cluster (`ecs.Cluster`)**:
  - An ECS cluster is created within the VPC to orchestrate the Fargate services.
  - Container Insights is enabled for enhanced monitoring.

- **CloudFront Distribution (`cloudfront.Distribution`)**:
  - This is the main distribution for the application.
  - **Default Behavior**: Serves static assets from the public S3 bucket (`cfPubBucket`). Basic authentication is added for non-production environments.
  - **`/api/*` Behavior**: Forwards requests to the Application Load Balancer (`lbDomainName`), effectively routing traffic to the backend service. Caching is disabled for this behavior.
  - **`/private/*` Behavior**: Serves content from the private S3 bucket (`cfPrivateBucket`) using the Origin Access Identity, ensuring secure access.

- **ECR Repository (`ecr.Repository`)**:
  - A private ECR repository is created to store the Docker images for the backend service.

- **SSM Parameter Store**:
  - An SSM parameter at `/total-ctl/{environment}/backend/ecr-repoName` is created to store the name of the ECR repository, allowing other processes or stacks to look it up.

## GitHub Actions Integration (Self-Propelling CI/CD)

To enable a "self-propelling" workflow where the CI/CD pipeline can manage its own infrastructure, the stack includes resources for integrating with GitHub Actions.

- **GitHub OIDC Provider**: The stack assumes that a GitHub OIDC provider has been created in the AWS account. This is a **one-time manual prerequisite** and the deployment will fail if it is not present. See the project's `INITIALIZATION.md` file for setup instructions.

- **IAM Deploy Role (`GithubActionsDeployRole`)**: The stack creates an IAM role that can be assumed by GitHub Actions. The trust policy for this role is scoped to the GitHub OIDC provider and the specific repository. This role is granted permissions to deploy the CDK stacks.

- **SSM Parameter (`/total-ctl/{environment}/github-actions/role-arn`)**: The ARN of the created deploy role is stored in the SSM Parameter Store. This allows the GitHub Actions workflows to easily retrieve the correct role ARN to assume for a given environment.

## Outputs

- The stack doesn't explicitly output any values, but its public properties (like `vpc`, `ecsCluster`, `cfPubBucket`, etc.) are passed to other stacks that depend on it. 